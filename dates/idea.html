<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>约会日记</title>
  <style>
    :root{ color-scheme: light; }
    *,*::before,*::after{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100svh;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(30,90,191,0.20), transparent 60%),
        radial-gradient(1000px 650px at 85% 20%, rgba(90,167,255,0.18), transparent 55%),
        radial-gradient(900px 700px at 50% 92%, rgba(231,240,255,0.80), transparent 62%),
        linear-gradient(180deg, #f7faff, #ffffff);
      overflow-x:hidden;
    }
    .wrap{max-width: 980px; margin:0 auto; padding: 18px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    h1{margin: 6px 0; font-size:20px; color: rgba(0,0,0,0.84);}
    .sub{margin:0; font-size:13px; color: rgba(0,0,0,0.52); line-height:1.6}

    .card{
      margin-top:14px;
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(255,255,255,0.80), rgba(255,255,255,0.62));
      border: 1px solid rgba(31,102,227,0.12);
      box-shadow: 0 28px 80px rgba(11,42,120,0.12), inset 0 1px 0 rgba(255,255,255,0.55);
      backdrop-filter: blur(16px);
      padding: 16px;
      position: relative;
      overflow: hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(500px 220px at 10% 5%, rgba(90,167,255,0.26), transparent 55%),
        radial-gradient(420px 240px at 90% 0%, rgba(11,42,120,0.14), transparent 60%);
      opacity: 0.55;
      pointer-events:none;
    }
    .card > *{ position: relative; }

    a.btn, button{
      border:0;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      cursor:pointer;
      background: rgba(255,255,255,0.82);
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      color: rgba(0,0,0,0.78);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      text-decoration:none;
      display:inline-block;
    }
    .pill{padding: 8px 10px; border-radius:999px; border:1px solid rgba(31,102,227,0.14); background: rgba(255,255,255,0.74); font-size: 13px;}
    button.primary{
      background: linear-gradient(135deg, #0b2a78, #5aa7ff);
      color:#fff;
      font-weight:900;
      box-shadow: 0 14px 34px rgba(31,102,227,0.22);
    }
    button.primary:disabled{opacity:0.6; cursor:not-allowed;}

    .meta{font-size:12px; color: rgba(0,0,0,0.48);}

    .ideaTitle{font-size:16px; color: rgba(0,0,0,0.82); font-weight:950;}
    .ideaTags{margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; font-size:12px;}
    .tag{display:inline-flex; align-items:center; gap:6px; padding: 4px 8px; border-radius:999px; border:1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.70); color: rgba(0,0,0,0.72)}
    .tag.t{background: rgba(11,42,120,0.10); border-color: rgba(11,42,120,0.18); color: rgba(11,42,120,0.92)}
    .tag.v{background: rgba(255,120,180,0.10); border-color: rgba(255,120,180,0.22); color: rgba(150,0,70,0.86)}
    .tag.c{background: rgba(90,167,255,0.12); border-color: rgba(90,167,255,0.22); color: rgba(0,70,160,0.86)}
    .tag.p{background: rgba(0,170,120,0.10); border-color: rgba(0,170,120,0.22); color: rgba(0,110,78,0.86)}
    .tag.x{background: rgba(120,120,120,0.10); border-color: rgba(120,120,120,0.20); color: rgba(60,60,60,0.86)}

    label{display:block; margin-top:12px; font-size:12px; color: rgba(0,0,0,0.55)}
    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      margin-top: 8px;
      border-radius: 18px;
      border: 1px solid rgba(31,102,227,0.16);
      padding: 12px;
      font-size: 14px;
      outline: none;
      background: rgba(255,255,255,0.92);
      line-height: 1.75;
    }
    input[type=file]{margin-top:8px; max-width:100%;}

    .thumbs{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;}
    .thumb{width:84px; height:84px; border-radius:18px; border:1px solid rgba(0,0,0,0.06); overflow:hidden; position:relative; background: rgba(255,255,255,0.74)}
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .thumb button{position:absolute; top:6px; right:6px; width:26px; height:26px; border-radius:999px; padding:0; border:0; cursor:pointer; background: rgba(0,0,0,0.55); color:#fff;}

    .list{margin-top:12px; display:grid; gap:10px;}
    .item{border-radius: 18px; border: 1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.68); padding: 12px;}
    .text{margin-top:6px; white-space: pre-wrap; font-size:14px; color: rgba(0,0,0,0.72); line-height:1.7;}
    .imgs{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;}
    .imgs img{width:110px; height:110px; object-fit:cover; border-radius:14px; border:1px solid rgba(0,0,0,0.06)}

    .toast{position:fixed; left:50%; bottom: 16px; transform: translateX(-50%);
      background: rgba(0,0,0,0.80); color:#fff; padding: 10px 14px; border-radius: 999px; font-size: 13px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.20); display:none; max-width: calc(100% - 24px); text-align:center; z-index: 50;}

    /* image modal */
    #imgModal{position:fixed; inset:0; display:none; place-items:center; padding:18px; background:rgba(10,16,30,0.72); backdrop-filter: blur(10px); z-index:200;}
  </style>
</head>
<body>
  <script>
    (function(){
      const USERS = new Set(['Theo','Evie']);
      const base = '/' + (location.pathname.split('/').filter(Boolean)[0] || '');
      try {
        const ok = localStorage.getItem('theo_auth_ok') === '1';
        const user = localStorage.getItem('theo_auth_user') || '';
        if (!ok || !USERS.has(user)) {
          location.replace(base + '/?next=' + encodeURIComponent(location.pathname.slice(base.length) + location.search + location.hash));
          return;
        }
        window.__AUTH__ = { user };
      } catch {
        location.replace(base + '/');
      }
    })();
  </script>

  <div class="wrap">
    <div class="top">
      <div>
        <h1 id="pageTitle">约会日记</h1>
        <p class="sub">点点滴滴都记下来～</p>
      </div>
      <div>
        <a class="btn" href="./">返回清单</a>
      </div>
    </div>

    <div class="card">
      <div class="meta">项目</div>
      <div class="ideaTitle" id="ideaTitle">加载中…</div>
      <div class="ideaTags" id="ideaTags"></div>

      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <button class="pill" id="editTagsBtn" type="button">编辑标签</button>
        <span class="meta" id="tagsHint" style="display:none;">点标签可删除；添加时会自动保证只有一个“类型”。</span>
      </div>

      <div id="tagEditor" style="display:none; margin-top:12px;">
        <div class="pillRow" style="gap:8px;">
          <button class="pill" id="addType_t" type="button">类型</button>
          <button class="pill" id="addType_v" type="button">氛围</button>
          <button class="pill" id="addType_c" type="button">约束</button>
          <button class="pill" id="addType_p" type="button">地点</button>
          <button class="pill" id="addType_x" type="button">其它</button>
        </div>

        <div class="pillRow" id="quickTags" style="margin-top:10px;"></div>

        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
          <input id="newTag" placeholder="例如：v:romantic / p:shenzhen-bay-park" style="flex:1; min-width: 240px; box-sizing:border-box;border-radius:16px;border:1px solid rgba(31,102,227,0.16);padding:11px 12px;font-size:14px;outline:none;background:rgba(255,255,255,0.92);" />
          <button class="pill" id="addTagBtn" type="button">添加</button>
          <button class="pill" id="saveTagsBtn" type="button">保存到清单</button>
        </div>
        <div class="meta" style="margin-top:10px; line-height:1.6;">
          规则：每个项目必须有 1 个类型（t:），且只能有 1 个类型。点击“保存”会更新 theo-notes（私库）里的 dates/ideas.json。
        </div>
      </div>
    </div>

    <div class="card">
      <div class="meta">写一篇日记</div>
      <label>今天发生了什么？</label>
      <textarea id="text" placeholder="记录一下：去哪里、吃了什么、谁说了什么傻话、心情怎样…"></textarea>

      <label>上传照片（可多张）</label>
      <input id="photos" type="file" accept="image/*" multiple />
      <div class="thumbs" id="thumbs"></div>

      <div style="display:flex; justify-content:flex-end; margin-top:12px;">
        <button class="primary" id="save">保存日记</button>
      </div>
      <div class="meta" style="margin-top:10px;">当前版本：只做最快可用（先不支持视频）。</div>
    </div>

    <div class="card">
      <div class="meta" id="logsTitle">关联日记</div>
      <div class="list" id="logs"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div id="imgModal">
    <div style="position:relative; width:min(920px, 100%); max-height: 90svh;">
      <button id="imgClose" style="position:absolute; top:-10px; right:-10px; width:42px; height:42px; border-radius:999px; border:1px solid rgba(255,255,255,0.20); background:rgba(255,255,255,0.14); color:#fff; cursor:pointer;">×</button>
      <img id="imgBig" alt="photo" style="width:100%; max-height: 90svh; object-fit:contain; border-radius: 22px; border:1px solid rgba(255,255,255,0.16); box-shadow: 0 28px 90px rgba(0,0,0,0.35); background: rgba(255,255,255,0.06);" />
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const toast = (msg) => {
      const t = $('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(() => t.style.display = 'none', 1600);
    };

    // image modal
    const imgModal = $('imgModal');
    const imgBig = $('imgBig');
    const imgClose = $('imgClose');
    function openImg(src){ imgBig.src = src; imgModal.style.display = 'grid'; }
    function closeImg(){ imgModal.style.display = 'none'; imgBig.src = ''; }
    imgClose.onclick = closeImg;
    imgModal.addEventListener('click', (e) => { if (e.target === imgModal) closeImg(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeImg(); });

    // --- Tag display ---
    const TAG_CN = {
      't:outdoor':'户外',
      't:food':'吃喝',
      't:life':'室内/日常',
      't:nightlife':'夜生活',
      't:culture':'文化/手作',
      't:watch':'观影/追剧',

      'v:challenge':'挑战/运动',
      'v:cozy':'舒服/松弛',
      'v:fun':'热闹/好玩',
      'v:healing':'治愈/放松',
      'v:photo':'出片',
      'v:romantic':'浪漫',

      'c:indoor':'室内',
      'c:outdoor':'室外',

      'p:shenzhen':'深圳',
      'p:guangzhou':'广州',
      'p:shenzhen-bay-park':'深圳湾公园',
      'p:qiedao':'企鹅岛',
      'p:xiwan-hongshulin':'西湾红树林',
      'p:huanle-gangwan':'欢乐港湾',
      'p:haishijie':'海上世界',
      'p:nantou-gucheng':'南头古城',
      'p:daxuecheng':'大学城',
      'p:f518':'F518 创意园',
      'p:dafen-youhuacun':'大芬油画村',
      'p:laifushi':'来福士',
      'p:haiancheng':'海岸城',
      'p:yuexiu-gongyuan':'越秀公园',
      'p:bulaien-gongyuan':'布莱恩公园',
      'p:bulage-dongjing':'布歌东京'
    };
    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function tagType(tag){
      if (/^t:/.test(tag)) return 't';
      if (/^v:/.test(tag)) return 'v';
      if (/^c:/.test(tag)) return 'c';
      if (/^p:/.test(tag)) return 'p';
      if (/^x:/.test(tag)) return 'x';
      return 'x';
    }
    function tagLabel(tag){
      const key = String(tag||'');
      if (TAG_CN[key]) return TAG_CN[key];
      const idx = key.indexOf(':');
      return idx > 0 ? key.slice(idx+1) : key;
    }
    function renderTags(el, tags, clickable = false){
      const arr = Array.isArray(tags) ? tags : [];
      const order = { t:0, v:1, c:2, p:3, x:4 };
      const sorted = arr.slice().sort((a,b)=> (order[tagType(a)]??9) - (order[tagType(b)]??9));
      el.innerHTML = sorted.map(t => {
        const data = clickable ? ` data-tag="${escapeHtml(t)}"` : '';
        const ttl = clickable ? '点击删除' : escapeHtml(t);
        return `<span class="tag ${tagType(t)}"${data} title="${ttl}">${escapeHtml(tagLabel(t))}</span>`;
      }).join('');
    }

    // --- Token gate (same as /notes/ & old /dates/) ---
    const KEY_STORAGE = 'theo_site_pass';
    async function b64ToBytes(b64){
      const bin = atob(String(b64).replace(/\n/g,''));
      const out = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i);
      return out;
    }
    async function decryptToken(pass){
      const enc = await fetch('./gh-token.enc.json', { cache: 'no-store' }).then(r=>r.json());
      const salt = await b64ToBytes(enc.salt);
      const iv = await b64ToBytes(enc.iv);
      const ct = await b64ToBytes(enc.ct);
      const tag = await b64ToBytes(enc.tag);
      const data = new Uint8Array(ct.length + tag.length);
      data.set(ct, 0);
      data.set(tag, ct.length);

      const baseKey = await crypto.subtle.importKey(
        'raw',
        new TextEncoder().encode(pass),
        { name: 'PBKDF2' },
        false,
        ['deriveKey']
      );

      const aesKey = await crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt, iterations: enc.iter || 150000, hash: 'SHA-256' },
        baseKey,
        { name: 'AES-GCM', length: 256 },
        false,
        ['decrypt']
      );

      const pt = await crypto.subtle.decrypt(
        { name: 'AES-GCM', iv },
        aesKey,
        data
      );

      return new TextDecoder('utf-8').decode(new Uint8Array(pt));
    }

    function getPass(){
      try { return localStorage.getItem(KEY_STORAGE) || ''; } catch { return ''; }
    }
    function setPass(v){
      try { localStorage.setItem(KEY_STORAGE, v); } catch {}
    }

    const gate = document.createElement('div');
    gate.style.cssText = 'position:fixed;inset:0;display:grid;place-items:center;padding:18px;background:rgba(245,249,255,0.66);backdrop-filter:blur(14px);z-index:99;';
    gate.innerHTML = `
      <div style="box-sizing:border-box;width:min(520px,calc(100% - 8px));max-width:100%;border-radius:24px;background:linear-gradient(180deg, rgba(255,255,255,0.88), rgba(255,255,255,0.72));border:1px solid rgba(31,102,227,0.14);box-shadow:0 28px 90px rgba(11,42,120,0.18);padding:18px 16px;overflow:hidden;">
        <div style="font-size:18px;font-weight:950;color:rgba(0,0,0,0.84)">约会日记</div>
        <div style="margin-top:8px;font-size:13px;color:rgba(0,0,0,0.55);line-height:1.65">请输入 4 位数口令（姐姐和我第一次见面的日子～）</div>
        <input id="keyInput" type="password" placeholder="口令" style="box-sizing:border-box;margin-top:12px;width:100%;max-width:100%;border-radius:16px;border:1px solid rgba(31,102,227,0.16);padding:11px 12px;font-size:14px;outline:none;background:rgba(255,255,255,0.92);" />
        <div id="keyErr" style="margin-top:10px;font-size:13px;color:#b0003a;display:none">口令不对哦，再试一次～</div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button id="keyOk" class="primary" style="border:0;border-radius:999px;padding:10px 14px;font-size:14px;cursor:pointer;background:linear-gradient(135deg,#0b2a78,#5aa7ff);color:#fff;font-weight:900;">进入</button>
        </div>
      </div>
    `;

    let GH_TOKEN = '';
    const GH_OWNER = 'xcuicui';
    const GH_REPO_NOTES = 'theo-notes';

    async function ensurePassAndToken(){
      const tryPass = async (p) => {
        try {
          const tok = await decryptToken(p);
          if (!tok || tok.length < 10) throw new Error('bad');
          GH_TOKEN = tok;
          setPass(p);
          return true;
        } catch {
          return false;
        }
      };

      const existing = getPass();
      if (existing) {
        const ok = await tryPass(existing);
        if (ok) return true;
      }

      document.body.appendChild(gate);
      const input = gate.querySelector('#keyInput');
      const err = gate.querySelector('#keyErr');
      const btn = gate.querySelector('#keyOk');

      const submit = async () => {
        err.style.display = 'none';
        const v = String(input.value || '').trim();
        if (!v) return;
        const ok = await tryPass(v);
        if (ok) {
          gate.remove();
          return true;
        }
        err.style.display = 'block';
        return false;
      };

      btn.onclick = submit;
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') submit(); });
      input.focus();
      return new Promise((resolve) => {
        btn.onclick = async () => resolve(await submit());
        input.addEventListener('keydown', async (e) => { if (e.key === 'Enter') resolve(await submit()); });
      });
    }

    // --- GitHub API helpers ---
    async function ghFetch(repo, path, opts = {}){
      const url = `https://api.github.com${path}`;
      const res = await fetch(url, {
        cache: 'no-store',
        ...opts,
        headers: {
          'authorization': `Bearer ${GH_TOKEN}`,
          'accept': 'application/vnd.github+json',
          'x-github-api-version': '2022-11-28',
          ...(opts.headers || {}),
        }
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`${res.status} ${t.slice(0, 200)}`);
      }
      return res.json();
    }

    async function ghFetchBlob(repo, path, opts = {}){
      const url = `https://api.github.com${path}`;
      const res = await fetch(url, {
        cache: 'no-store',
        ...opts,
        headers: {
          'authorization': `Bearer ${GH_TOKEN}`,
          'accept': 'application/vnd.github.raw',
          'x-github-api-version': '2022-11-28',
          ...(opts.headers || {}),
        }
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`${res.status} ${t.slice(0, 200)}`);
      }
      return res.blob();
    }

    async function ghGetFile(repo, repoPath){
      const enc = repoPath.split('/').map(encodeURIComponent).join('/');
      return ghFetch(repo, `/repos/${encodeURIComponent(GH_OWNER)}/${encodeURIComponent(repo)}/contents/${enc}?ref=main`);
    }

    function b64ToUtf8(b64){
      const bin = atob(String(b64).replace(/\n/g,''));
      const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
      return new TextDecoder('utf-8').decode(bytes);
    }

    async function ghTryGetJson(repo, path){
      try {
        const f = await ghGetFile(repo, path);
        const txt = f.encoding === 'base64' ? b64ToUtf8(f.content) : '';
        return JSON.parse(txt);
      } catch {
        return null;
      }
    }

    async function base64Utf8(str){
      const bytes = new TextEncoder().encode(str);
      let bin = '';
      bytes.forEach(b => bin += String.fromCharCode(b));
      return btoa(bin);
    }

    async function ghPutFile(repo, path, contentBase64, message, shaOverride){
      const url = `/repos/${GH_OWNER}/${repo}/contents/${encodeURIComponent(path).replaceAll('%2F','/')}?ref=main`;
      let sha = shaOverride;
      if (!sha) {
        try {
          const j = await ghFetch(repo, url);
          sha = j && j.sha;
        } catch {}
      }

      const putUrl = `/repos/${GH_OWNER}/${repo}/contents/${encodeURIComponent(path).replaceAll('%2F','/')}`;
      return ghFetch(repo, putUrl, {
        method: 'PUT',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ message, content: contentBase64, branch: 'main', sha }),
      });
    }

    const __imgUrlCache = new Map();
    async function getPrivateImageUrl(repoPath){
      const key = String(repoPath || '');
      if (!key) return '';
      if (__imgUrlCache.has(key)) return __imgUrlCache.get(key);
      const enc = key.split('/').map(encodeURIComponent).join('/');
      const blob = await ghFetchBlob(GH_REPO_NOTES, `/repos/${encodeURIComponent(GH_OWNER)}/${encodeURIComponent(GH_REPO_NOTES)}/contents/${enc}?ref=main`);
      const url = URL.createObjectURL(blob);
      __imgUrlCache.set(key, url);
      return url;
    }

    // image upload helpers (HEIC + big -> jpeg)
    async function blobToBase64(blob){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => {
          const dataUrl = String(r.result || '');
          const b64 = dataUrl.split(',')[1] || '';
          resolve(b64);
        };
        r.onerror = () => reject(r.error);
        r.readAsDataURL(blob);
      });
    }

    async function compressToJpegBase64(file, opts = {}){
      const { maxSide = 1600, quality = 0.82 } = opts;
      const url = URL.createObjectURL(file);
      try {
        const img = await new Promise((resolve, reject) => {
          const im = new Image();
          im.onload = () => resolve(im);
          im.onerror = reject;
          im.src = url;
        });

        const w0 = img.naturalWidth || img.width;
        const h0 = img.naturalHeight || img.height;
        const scale = Math.min(1, maxSide / Math.max(w0, h0));
        const w = Math.max(1, Math.round(w0 * scale));
        const h = Math.max(1, Math.round(h0 * scale));

        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', quality));
        if (!blob) throw new Error('toBlob_failed');
        const b64 = await blobToBase64(blob);
        return { b64, ext: 'jpg', mime: 'image/jpeg' };
      } finally {
        URL.revokeObjectURL(url);
      }
    }

    async function readFileAsBase64(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => {
          const dataUrl = String(r.result || '');
          const b64 = dataUrl.split(',')[1] || '';
          resolve(b64);
        };
        r.onerror = () => reject(r.error);
        r.readAsDataURL(file);
      });
    }

    async function imageToUploadPayload(file){
      const name = String(file.name || '');
      const ext0 = (name.split('.').pop() || '').toLowerCase();
      const isHeic = (file.type && /heic|heif/i.test(file.type)) || ext0 === 'heic' || ext0 === 'heif';
      const isBig = (file.size || 0) > 2.5 * 1024 * 1024;

      if (isHeic || isBig) {
        try {
          return await compressToJpegBase64(file, { maxSide: 1600, quality: 0.82 });
        } catch (e) {
          console.warn('compress fail, fallback original', e);
        }
      }

      const b64 = await readFileAsBase64(file);
      const ext = ext0 || (file.type==='image/jpeg'?'jpg':file.type==='image/png'?'png':'bin');
      return { b64, ext, mime: file.type || 'application/octet-stream' };
    }

    // --- app ---
    function getIdeaId(){
      const u = new URL(location.href);
      return u.searchParams.get('id') || '';
    }

    let ideas = [];
    let curIdea = null;
    let logsIndex = { items: [] };

    // --- tag editor ---
    let activeAddType = 'v';
    const QUICK = {
      t: [
        ['t:outdoor','户外'],
        ['t:food','吃喝'],
        ['t:life','室内/日常'],
        ['t:nightlife','夜生活'],
        ['t:culture','文化/手作'],
        ['t:watch','观影/追剧'],
      ],
      v: [
        ['v:cozy','舒服/松弛'],
        ['v:fun','热闹/好玩'],
        ['v:romantic','浪漫'],
        ['v:healing','治愈/放松'],
        ['v:photo','出片'],
        ['v:challenge','挑战/运动'],
      ],
      c: [
        ['c:indoor','室内'],
        ['c:outdoor','室外'],
      ],
      p: [
        ['p:shenzhen','深圳'],
        ['p:guangzhou','广州'],
        ['p:shenzhen-bay-park','深圳湾公园'],
        ['p:haishijie','海上世界'],
        ['p:nantou-gucheng','南头古城'],
        ['p:huanle-gangwan','欢乐港湾'],
      ],
      x: [
        ['x:sunset','日落'],
        ['x:sunrise','日出'],
        ['x:nightview','夜景'],
        ['x:daily','日常'],
      ]
    };

    function normalizeTagInput(s){
      return String(s||'').trim();
    }

    function getTTag(tags){
      const arr = Array.isArray(tags) ? tags : [];
      return arr.find(t => /^t:/.test(t)) || '';
    }

    function setActiveAddType(t){
      activeAddType = t;
      ['t','v','c','p','x'].forEach(k => {
        const el = document.getElementById('addType_' + k);
        if (el) el.style.outline = (k===t) ? '3px solid rgba(11,42,120,0.18)' : 'none';
      });
      renderQuickTags();
    }

    function renderQuickTags(){
      const box = document.getElementById('quickTags');
      if (!box) return;
      const items = QUICK[activeAddType] || [];
      box.innerHTML = items.map(([tag, label]) => {
        return `<button class="pill" type="button" data-tag="${escapeHtml(tag)}">+ ${escapeHtml(label)}</button>`;
      }).join('');
      box.querySelectorAll('button[data-tag]').forEach(b => {
        b.onclick = () => addTagToIdea(b.getAttribute('data-tag') || '');
      });
    }

    function addTagToIdea(tag){
      if (!curIdea) return;
      tag = normalizeTagInput(tag);
      if (!tag) return;
      curIdea.tags = Array.isArray(curIdea.tags) ? curIdea.tags : [];

      // enforce: only one t:
      if (/^t:/.test(tag)) {
        curIdea.tags = curIdea.tags.filter(x => !/^t:/.test(x));
        curIdea.tags.unshift(tag);
      } else {
        if (!curIdea.tags.includes(tag)) curIdea.tags.push(tag);
      }

      refreshIdeaTagsUI(true);
    }

    function removeTagFromIdea(tag){
      if (!curIdea) return;
      curIdea.tags = Array.isArray(curIdea.tags) ? curIdea.tags : [];
      if (/^t:/.test(tag)) {
        // must keep one t:
        const t0 = getTTag(curIdea.tags);
        if (t0 && t0 === tag) {
          toast('类型（t:）必须保留 1 个～');
          return;
        }
      }
      curIdea.tags = curIdea.tags.filter(x => x !== tag);
      refreshIdeaTagsUI(true);
    }

    function refreshIdeaTagsUI(clickable){
      const tagsEl = document.getElementById('ideaTags');
      if (!tagsEl) return;
      renderTags(tagsEl, curIdea ? (curIdea.tags||[]) : [], clickable);
      if (clickable) {
        tagsEl.querySelectorAll('.tag[data-tag]').forEach(el => {
          el.onclick = (e) => {
            e.preventDefault();
            const t = el.getAttribute('data-tag') || '';
            removeTagFromIdea(t);
          };
        });
      }
    }

    async function saveIdeaTagsToNotes(){
      if (!curIdea) return;
      if (!getTTag(curIdea.tags)) {
        toast('请先选一个“类型（t:）”');
        return;
      }

      const btn = document.getElementById('saveTagsBtn');
      const old = btn ? btn.textContent : '';
      if (btn) { btn.disabled = true; btn.textContent = '保存中…'; }

      try {
        const file = await ghGetFile(GH_REPO_NOTES, 'dates/ideas.json');
        const sha = file && file.sha;
        const txt = file.encoding === 'base64' ? b64ToUtf8(file.content) : '';
        const arr = JSON.parse(txt);
        if (!Array.isArray(arr)) throw new Error('ideas_not_array');
        const idx = arr.findIndex(x => String(x.id) === String(curIdea.id));
        if (idx < 0) throw new Error('idea_not_found_in_notes_repo');
        arr[idx].tags = curIdea.tags;

        const out = JSON.stringify(arr, null, 2);
        const b64 = await base64Utf8(out);
        await ghPutFile(GH_REPO_NOTES, 'dates/ideas.json', b64, `Update tags for ${curIdea.id}`, sha);
        toast('标签已保存～');
      } catch (e) {
        console.warn(e);
        toast('保存失败：' + String(e).slice(0, 120));
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = old || '保存'; }
      }
    }

    async function loadIdeas(){
      const r = await fetch('./ideas.json', { cache: 'no-store' });
      const j = await r.json();
      ideas = Array.isArray(j) ? j : [];
    }

    async function loadLogsIndex(){
      const idx = await ghTryGetJson(GH_REPO_NOTES, 'dates/index.json');
      logsIndex = (idx && typeof idx === 'object') ? idx : { items: [] };
      logsIndex.items = Array.isArray(logsIndex.items) ? logsIndex.items : [];
    }

    async function renderLogs(){
      const el = $('logs');
      const title = $('logsTitle');
      el.innerHTML = '';
      if (!curIdea) {
        title.textContent = '关联日记';
        el.innerHTML = '<div class="meta">没有找到这个项目～</div>';
        return;
      }

      title.textContent = `「${curIdea.title || curIdea.id}」的日记`;

      const items = (logsIndex.items || []).filter(x => Array.isArray(x.ideaIds) && x.ideaIds.includes(curIdea.id));
      items.sort((a,b) => (b.ts||0) - (a.ts||0));

      if (!items.length) {
        el.innerHTML = '<div class="meta">还没有日记。写一篇吧～</div>';
        return;
      }

      for (const it of items.slice(0, 50)) {
        const div = document.createElement('div');
        div.className = 'item';
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${new Date(it.ts || Date.now()).toLocaleString('zh-CN')} · ${it.author || ''}`.trim();
        const text = document.createElement('div');
        text.className = 'text';
        text.textContent = it.text || '';
        div.appendChild(meta);
        if (text.textContent) div.appendChild(text);

        const imgsArr = Array.isArray(it.images) ? it.images : [];
        if (imgsArr.length) {
          const imgs = document.createElement('div');
          imgs.className = 'imgs';
          for (const p of imgsArr.slice(0, 12)) {
            const img = document.createElement('img');
            img.alt = 'photo';
            img.loading = 'lazy';
            img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
            (async () => {
              try {
                const url = await getPrivateImageUrl(p);
                img.src = url;
                img.onclick = () => openImg(url);
              } catch (e) {
                console.warn('load image failed', p, e);
              }
            })();
            imgs.appendChild(img);
          }
          div.appendChild(imgs);
        }

        el.appendChild(div);
      }
    }

    // photo preview
    let selectedFiles = [];
    const thumbsEl = $('thumbs');
    function renderThumbs(){
      thumbsEl.innerHTML = '';
      selectedFiles.forEach((f, idx) => {
        const div = document.createElement('div');
        div.className = 'thumb';
        const img = document.createElement('img');
        img.alt = 'preview';
        img.src = URL.createObjectURL(f);
        img.onclick = () => openImg(img.src);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = '×';
        btn.onclick = () => {
          selectedFiles.splice(idx, 1);
          renderThumbs();
        };
        div.appendChild(img);
        div.appendChild(btn);
        thumbsEl.appendChild(div);
      });
    }
    $('photos').addEventListener('change', () => {
      selectedFiles = Array.from($('photos').files || []);
      renderThumbs();
    });

    $('save').onclick = async () => {
      if (!curIdea) { toast('没有找到项目～'); return; }
      const btn = $('save');
      const text = String($('text').value || '').trim();
      const files = selectedFiles.length ? selectedFiles : Array.from($('photos').files || []);
      if (!text && files.length === 0) { toast('写点什么或传张照片再保存哦～'); return; }

      const old = btn.textContent;
      btn.disabled = true;
      btn.textContent = '保存中…';

      try {
        const ts = Date.now();
        const d = new Date(ts);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const HH = String(d.getHours()).padStart(2,'0');
        const MM = String(d.getMinutes()).padStart(2,'0');
        const SS = String(d.getSeconds()).padStart(2,'0');
        const day = `${yyyy}-${mm}-${dd}`;
        const dayDir = `dates/${day}`;
        const stamp = `${HH}${MM}${SS}`;

        const author = (window.__AUTH__ && window.__AUTH__.user) ? String(window.__AUTH__.user) : '';

        const imgPaths = [];
        for (let i=0;i<files.length;i++) {
          btn.textContent = `上传照片 ${i+1}/${files.length}…`;
          const payload = await imageToUploadPayload(files[i]);
          const path = `${dayDir}/images/${stamp}-${i+1}.${payload.ext}`;
          imgPaths.push(path);
          await ghPutFile(GH_REPO_NOTES, path, payload.b64, `Add date photo ${day} ${stamp} #${i+1}`);
        }

        const dailyPath = `${dayDir}/entries.json`;
        const daily = (await ghTryGetJson(GH_REPO_NOTES, dailyPath)) || { day, items: [] };
        daily.items = Array.isArray(daily.items) ? daily.items : [];
        daily.items.unshift({ ts, ideaIds: [curIdea.id], text, images: imgPaths, author });
        await ghPutFile(GH_REPO_NOTES, dailyPath, await base64Utf8(JSON.stringify(daily, null, 2)), `Update date entries ${day}`);

        const idxPath = 'dates/index.json';
        const idx = (await ghTryGetJson(GH_REPO_NOTES, idxPath)) || { items: [] };
        idx.items = Array.isArray(idx.items) ? idx.items : [];
        idx.items.unshift({ ts, day, ideaIds: [curIdea.id], text, images: imgPaths, author });
        idx.items = idx.items.slice(0, 400);
        await ghPutFile(GH_REPO_NOTES, idxPath, await base64Utf8(JSON.stringify(idx, null, 2)), `Update dates index ${day}`);

        logsIndex = idx;
        $('text').value = '';
        $('photos').value = '';
        selectedFiles = [];
        renderThumbs();

        toast('已保存～');
        await renderLogs();
      } catch (e) {
        console.warn(e);
        toast('保存失败：' + String(e).slice(0, 120));
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    };

    (async () => {
      const ok = await ensurePassAndToken();
      if (!ok) return;

      await loadIdeas();
      const id = getIdeaId();
      curIdea = ideas.find(x => String(x.id) === String(id)) || null;

      if (!curIdea) {
        $('ideaTitle').textContent = '项目不存在或链接不对';
        $('pageTitle').textContent = '约会日记';
        $('ideaTags').innerHTML = '';
        await loadLogsIndex();
        await renderLogs();
        return;
      }

      $('pageTitle').textContent = `约会日记 · ${curIdea.title || curIdea.id}`;
      $('ideaTitle').textContent = curIdea.title || curIdea.id;
      refreshIdeaTagsUI(false);

      // tag editor bindings
      const editBtn = document.getElementById('editTagsBtn');
      const editor = document.getElementById('tagEditor');
      const hint = document.getElementById('tagsHint');
      if (editBtn && editor) {
        editBtn.onclick = () => {
          const on = editor.style.display !== 'none';
          editor.style.display = on ? 'none' : 'block';
          if (hint) hint.style.display = on ? 'none' : 'inline';
          editBtn.textContent = on ? '编辑标签' : '完成';
          refreshIdeaTagsUI(!on);
          if (!on) {
            setActiveAddType(activeAddType || 'v');
          }
        };
      }

      ['t','v','c','p','x'].forEach(k => {
        const b = document.getElementById('addType_' + k);
        if (b) b.onclick = () => setActiveAddType(k);
      });
      const addBtn = document.getElementById('addTagBtn');
      const input = document.getElementById('newTag');
      if (addBtn && input) {
        addBtn.onclick = () => {
          addTagToIdea(input.value);
          input.value = '';
        };
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addBtn.click(); } });
      }
      const saveTagsBtn = document.getElementById('saveTagsBtn');
      if (saveTagsBtn) saveTagsBtn.onclick = () => saveIdeaTagsToNotes();

      await loadLogsIndex();
      await renderLogs();
    })();
  </script>
</body>
</html>
