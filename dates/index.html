<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Theo 的约会清单</title>
  <style>
    :root{ color-scheme: light; }
    *,*::before,*::after{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100svh;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(30,90,191,0.20), transparent 60%),
        radial-gradient(1000px 650px at 85% 20%, rgba(90,167,255,0.18), transparent 55%),
        radial-gradient(900px 700px at 50% 92%, rgba(231,240,255,0.80), transparent 62%),
        linear-gradient(180deg, #f7faff, #ffffff);
      overflow-x:hidden;
    }
    .wrap{max-width: 980px; margin:0 auto; padding: 18px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    h1{margin: 6px 0; font-size:22px; color: rgba(0,0,0,0.84);}
    .sub{margin:0; font-size:13px; color: rgba(0,0,0,0.52); line-height:1.6}

    .card{
      margin-top:14px;
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(255,255,255,0.80), rgba(255,255,255,0.62));
      border: 1px solid rgba(31,102,227,0.12);
      box-shadow: 0 28px 80px rgba(11,42,120,0.12), inset 0 1px 0 rgba(255,255,255,0.55);
      backdrop-filter: blur(16px);
      padding: 16px;
      position: relative;
      overflow: hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(500px 220px at 10% 5%, rgba(90,167,255,0.26), transparent 55%),
        radial-gradient(420px 240px at 90% 0%, rgba(11,42,120,0.14), transparent 60%);
      opacity: 0.55;
      pointer-events:none;
    }
    .card > *{ position: relative; }

    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px;}
    @media (max-width: 860px){ .grid{ grid-template-columns: 1fr; } }

    a.btn, button{
      border:0;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      cursor:pointer;
      background: rgba(255,255,255,0.82);
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      color: rgba(0,0,0,0.78);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      text-decoration:none;
      display:inline-block;
    }
    button.primary{
      background: linear-gradient(135deg, #0b2a78, #5aa7ff);
      color:#fff;
      font-weight:900;
      box-shadow: 0 14px 34px rgba(31,102,227,0.22);
    }
    button.primary:disabled{opacity:0.6; cursor:not-allowed;}

    .meta{font-size:12px; color: rgba(0,0,0,0.48);}
    .ideaList{margin-top:10px; display:grid; gap:10px;}
    .groupTitle{font-weight:950; color: rgba(0,0,0,0.74); margin-top:8px;}
    .ideaBtn{
      width:100%;
      text-align:left;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.72);
      border-radius: 18px;
      padding: 10px 12px;
      box-shadow: 0 12px 28px rgba(11,42,120,0.08);
    }
    .ideaBtn.sel{ outline: 3px solid rgba(11,42,120,0.18); }
    .ideaTitle{font-size:14px; color: rgba(0,0,0,0.78); font-weight:900;}
    .ideaTags{margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; font-size:12px; color: rgba(0,0,0,0.46)}
    .tag{display:inline-flex; align-items:center; gap:6px; padding: 4px 8px; border-radius:999px; border:1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.70); color: rgba(0,0,0,0.72)}
    .tag.t{background: rgba(11,42,120,0.10); border-color: rgba(11,42,120,0.18); color: rgba(11,42,120,0.92)}
    .tag.v{background: rgba(255,120,180,0.10); border-color: rgba(255,120,180,0.22); color: rgba(150,0,70,0.86)}
    .tag.c{background: rgba(90,167,255,0.12); border-color: rgba(90,167,255,0.22); color: rgba(0,70,160,0.86)}
    .tag.p{background: rgba(0,170,120,0.10); border-color: rgba(0,170,120,0.22); color: rgba(0,110,78,0.86)}
    .tag.x{background: rgba(120,120,120,0.10); border-color: rgba(120,120,120,0.20); color: rgba(60,60,60,0.86)}

    label{display:block; margin-top:12px; font-size:12px; color: rgba(0,0,0,0.55)}
    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      margin-top: 8px;
      border-radius: 18px;
      border: 1px solid rgba(31,102,227,0.16);
      padding: 12px;
      font-size: 14px;
      outline: none;
      background: rgba(255,255,255,0.92);
      line-height: 1.75;
    }
    input[type=file]{margin-top:8px; max-width:100%;}

    .thumbs{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;}
    .thumb{width:84px; height:84px; border-radius:18px; border:1px solid rgba(0,0,0,0.06); overflow:hidden; position:relative; background: rgba(255,255,255,0.74)}
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .thumb button{position:absolute; top:6px; right:6px; width:26px; height:26px; border-radius:999px; padding:0; border:0; cursor:pointer; background: rgba(0,0,0,0.55); color:#fff;}

    .list{margin-top:12px; display:grid; gap:10px;}
    .item{border-radius: 18px; border: 1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.68); padding: 12px;}
    .text{margin-top:6px; white-space: pre-wrap; font-size:14px; color: rgba(0,0,0,0.72); line-height:1.7;}
    .imgs{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;}
    .imgs img{width:110px; height:110px; object-fit:cover; border-radius:14px; border:1px solid rgba(0,0,0,0.06)}

    .toast{position:fixed; left:50%; bottom: 16px; transform: translateX(-50%);
      background: rgba(0,0,0,0.80); color:#fff; padding: 10px 14px; border-radius: 999px; font-size: 13px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.20); display:none; max-width: calc(100% - 24px); text-align:center; z-index: 50;}

    .pillRow{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .pill{padding: 8px 10px; border-radius:999px; border:1px solid rgba(31,102,227,0.14); background: rgba(255,255,255,0.74); font-size: 13px;}

    /* image modal */
    #imgModal{position:fixed; inset:0; display:none; place-items:center; padding:18px; background:rgba(10,16,30,0.72); backdrop-filter: blur(10px); z-index:200;}
  </style>
</head>
<body>
  <script>
    (function(){
      const USERS = new Set(['Theo','Evie']);
      const base = '/' + (location.pathname.split('/').filter(Boolean)[0] || '');
      try {
        const ok = localStorage.getItem('theo_auth_ok') === '1';
        const user = localStorage.getItem('theo_auth_user') || '';
        if (!ok || !USERS.has(user)) {
          location.replace(base + '/?next=' + encodeURIComponent(location.pathname.slice(base.length) + location.search + location.hash));
          return;
        }
        window.__AUTH__ = { user };
      } catch {
        location.replace(base + '/');
      }
    })();
  </script>

  <div class="wrap">
    <div class="top">
      <div>
        <h1>Theo 的约会清单</h1>
        <p class="sub">把想做的约会都收起来；每一项都可以写日记 + 传照片。</p>
      </div>
      <div class="pillRow">
        <a class="btn" href="../greeting/">返回问候页</a>
        <a class="btn" href="../notes/">碎碎念</a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="meta">清单</div>
        <div class="pillRow" style="margin-top:10px;">
          <span class="pill" id="stat"></span>
          <button class="pill" id="reloadIdeas">刷新</button>
          <button class="pill" id="clearFilters" style="display:none;">清空筛选</button>
        </div>
        <div class="pillRow" id="selectedFilters" style="margin-top:10px; display:none;"></div>

        <div class="pillRow" id="groupTypeBar" style="margin-top:10px;">
          <span class="meta" style="margin-right:6px;">按标签分类：</span>
          <button class="pill" id="group_t">类型</button>
          <button class="pill" id="group_v">氛围</button>
          <button class="pill" id="group_c">约束</button>
          <button class="pill" id="group_p">地点</button>
          <button class="pill" id="group_none">不分类</button>
        </div>

        <div class="ideaList" id="ideaList"></div>
        <div class="meta" style="margin-top:10px;">提示：当前 ideas.json 先放了一个示例项；你把截图里的清单整理进 ideas.json 就能全部显示。</div>
      </div>

      <div>
        <div class="card">
          <div class="meta">给这个约会写日记</div>
          <div style="margin-top:8px; font-weight:950; color:rgba(0,0,0,0.80)" id="curIdeaTitle">先在左边选一项～</div>

          <label>今天发生了什么？</label>
          <textarea id="text" placeholder="记录一下：去哪里、吃了什么、谁说了什么傻话、心情怎样…"></textarea>

          <label>上传照片（可多张）</label>
          <input id="photos" type="file" accept="image/*" multiple />
          <div class="thumbs" id="thumbs"></div>

          <div class="pillRow" style="margin-top:12px; justify-content:flex-end;">
            <button class="primary" id="save">保存日记</button>
          </div>
          <div class="meta" style="margin-top:10px;">当前版本：只做最快可用（先不支持视频）。</div>
        </div>

        <div class="card">
          <div class="meta" id="logsTitle">关联日记</div>
          <div class="list" id="logs"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div id="imgModal">
    <div style="position:relative; width:min(920px, 100%); max-height: 90svh;">
      <button id="imgClose" style="position:absolute; top:-10px; right:-10px; width:42px; height:42px; border-radius:999px; border:1px solid rgba(255,255,255,0.20); background:rgba(255,255,255,0.14); color:#fff; cursor:pointer;">×</button>
      <img id="imgBig" alt="photo" style="width:100%; max-height: 90svh; object-fit:contain; border-radius: 22px; border:1px solid rgba(255,255,255,0.16); box-shadow: 0 28px 90px rgba(0,0,0,0.35); background: rgba(255,255,255,0.06);" />
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const toast = (msg) => {
      const t = $('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(() => t.style.display = 'none', 1600);
    };

    // image modal
    const imgModal = $('imgModal');
    const imgBig = $('imgBig');
    const imgClose = $('imgClose');
    function openImg(src){
      imgBig.src = src;
      imgModal.style.display = 'grid';
    }
    function closeImg(){
      imgModal.style.display = 'none';
      imgBig.src = '';
    }
    imgClose.onclick = closeImg;
    imgModal.addEventListener('click', (e) => { if (e.target === imgModal) closeImg(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeImg(); });

    // photo preview
    let selectedFiles = [];
    const thumbsEl = $('thumbs');
    function renderThumbs(){
      thumbsEl.innerHTML = '';
      selectedFiles.forEach((f, idx) => {
        const div = document.createElement('div');
        div.className = 'thumb';
        const img = document.createElement('img');
        img.alt = 'preview';
        img.src = URL.createObjectURL(f);
        img.onclick = () => openImg(img.src);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = '×';
        btn.onclick = () => {
          selectedFiles.splice(idx, 1);
          renderThumbs();
        };
        div.appendChild(img);
        div.appendChild(btn);
        thumbsEl.appendChild(div);
      });
    }
    $('photos').addEventListener('change', () => {
      selectedFiles = Array.from($('photos').files || []);
      renderThumbs();
    });

    // --- Token gate (reuse same mechanism as /notes/) ---
    const KEY_STORAGE = 'theo_site_pass';
    async function b64ToBytes(b64){
      const bin = atob(String(b64).replace(/\n/g,''));
      const out = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i);
      return out;
    }

    async function decryptToken(pass){
      const enc = await fetch('./gh-token.enc.json', { cache: 'no-store' }).then(r=>r.json());
      const salt = await b64ToBytes(enc.salt);
      const iv = await b64ToBytes(enc.iv);
      const ct = await b64ToBytes(enc.ct);
      const tag = await b64ToBytes(enc.tag);
      const data = new Uint8Array(ct.length + tag.length);
      data.set(ct, 0);
      data.set(tag, ct.length);

      const baseKey = await crypto.subtle.importKey(
        'raw',
        new TextEncoder().encode(pass),
        { name: 'PBKDF2' },
        false,
        ['deriveKey']
      );

      const aesKey = await crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt, iterations: enc.iter || 150000, hash: 'SHA-256' },
        baseKey,
        { name: 'AES-GCM', length: 256 },
        false,
        ['decrypt']
      );

      const pt = await crypto.subtle.decrypt(
        { name: 'AES-GCM', iv },
        aesKey,
        data
      );

      return new TextDecoder('utf-8').decode(new Uint8Array(pt));
    }

    function getPass(){
      try { return localStorage.getItem(KEY_STORAGE) || ''; } catch { return ''; }
    }
    function setPass(v){
      try { localStorage.setItem(KEY_STORAGE, v); } catch {}
    }

    const gate = document.createElement('div');
    gate.style.cssText = 'position:fixed;inset:0;display:grid;place-items:center;padding:18px;background:rgba(245,249,255,0.66);backdrop-filter:blur(14px);z-index:99;';
    gate.innerHTML = `
      <div style="box-sizing:border-box;width:min(520px,calc(100% - 8px));max-width:100%;border-radius:24px;background:linear-gradient(180deg, rgba(255,255,255,0.88), rgba(255,255,255,0.72));border:1px solid rgba(31,102,227,0.14);box-shadow:0 28px 90px rgba(11,42,120,0.18);padding:18px 16px;overflow:hidden;">
        <div style="font-size:18px;font-weight:950;color:rgba(0,0,0,0.84)">约会日记</div>
        <div style="margin-top:8px;font-size:13px;color:rgba(0,0,0,0.55);line-height:1.65">请输入 4 位数口令（姐姐和我第一次见面的日子～）</div>
        <input id="keyInput" type="password" placeholder="口令" style="box-sizing:border-box;margin-top:12px;width:100%;max-width:100%;border-radius:16px;border:1px solid rgba(31,102,227,0.16);padding:11px 12px;font-size:14px;outline:none;background:rgba(255,255,255,0.92);" />
        <div id="keyErr" style="margin-top:10px;font-size:13px;color:#b0003a;display:none">口令不对哦，再试一次～</div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button id="keyOk" class="primary" style="border:0;border-radius:999px;padding:10px 14px;font-size:14px;cursor:pointer;background:linear-gradient(135deg,#0b2a78,#5aa7ff);color:#fff;font-weight:900;">进入</button>
        </div>
      </div>
    `;

    let GH_TOKEN = '';
    const GH_OWNER = 'xcuicui';
    const GH_REPO = 'theo-notes';

    async function ensurePassAndToken(){
      const tryPass = async (p) => {
        try {
          const tok = await decryptToken(p);
          if (!tok || tok.length < 10) throw new Error('bad');
          GH_TOKEN = tok;
          setPass(p);
          return true;
        } catch {
          return false;
        }
      };

      const existing = getPass();
      if (existing) {
        const ok = await tryPass(existing);
        if (ok) return true;
      }

      document.body.appendChild(gate);
      const input = gate.querySelector('#keyInput');
      const err = gate.querySelector('#keyErr');
      const btn = gate.querySelector('#keyOk');

      const submit = async () => {
        err.style.display = 'none';
        const v = String(input.value || '').trim();
        if (!v) return;
        const ok = await tryPass(v);
        if (ok) {
          gate.remove();
          return true;
        }
        err.style.display = 'block';
        return false;
      };

      btn.onclick = submit;
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') submit(); });
      input.focus();
      return new Promise((resolve) => {
        btn.onclick = async () => resolve(await submit());
        input.addEventListener('keydown', async (e) => { if (e.key === 'Enter') resolve(await submit()); });
      });
    }

    // --- GitHub API helpers ---
    async function ghFetch(path, opts = {}){
      const url = `https://api.github.com${path}`;
      const res = await fetch(url, {
        ...opts,
        headers: {
          'authorization': `Bearer ${GH_TOKEN}`,
          'accept': 'application/vnd.github+json',
          'x-github-api-version': '2022-11-28',
          ...(opts.headers || {}),
        }
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`${res.status} ${t.slice(0, 200)}`);
      }
      return res.json();
    }

    async function ghGetFile(repoPath){
      const enc = repoPath.split('/').map(encodeURIComponent).join('/');
      return ghFetch(`/repos/${encodeURIComponent(GH_OWNER)}/${encodeURIComponent(GH_REPO)}/contents/${enc}?ref=main`);
    }

    function b64ToUtf8(b64){
      const bin = atob(String(b64).replace(/\n/g,''));
      const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
      return new TextDecoder('utf-8').decode(bytes);
    }

    async function ghTryGetJson(path){
      try {
        const f = await ghGetFile(path);
        const txt = f.encoding === 'base64' ? b64ToUtf8(f.content) : '';
        return JSON.parse(txt);
      } catch {
        return null;
      }
    }

    async function base64Utf8(str){
      const bytes = new TextEncoder().encode(str);
      let bin = '';
      bytes.forEach(b => bin += String.fromCharCode(b));
      return btoa(bin);
    }

    async function ghPutFile(path, contentBase64, message){
      const url = `/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(path).replaceAll('%2F','/')}?ref=main`;
      let sha;
      try {
        const j = await ghFetch(url);
        sha = j && j.sha;
      } catch {}

      const putUrl = `/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(path).replaceAll('%2F','/')}`;
      return ghFetch(putUrl, {
        method: 'PUT',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ message, content: contentBase64, branch: 'main', sha }),
      });
    }

    // --- Private repo image display helpers ---
    // Note: <img src="https://raw.githubusercontent.com/..."> will NOT work for private repos.
    // We fetch blobs with Authorization, then convert to blob: URLs.
    async function ghFetchBlob(path, opts = {}){
      const url = `https://api.github.com${path}`;
      const res = await fetch(url, {
        ...opts,
        headers: {
          'authorization': `Bearer ${GH_TOKEN}`,
          'accept': 'application/vnd.github.raw',
          'x-github-api-version': '2022-11-28',
          ...(opts.headers || {}),
        }
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`${res.status} ${t.slice(0, 200)}`);
      }
      return res.blob();
    }

    const __imgUrlCache = new Map(); // repoPath -> blobUrl
    async function getPrivateImageUrl(repoPath){
      const key = String(repoPath || '');
      if (!key) return '';
      if (__imgUrlCache.has(key)) return __imgUrlCache.get(key);

      const enc = key.split('/').map(encodeURIComponent).join('/');
      const blob = await ghFetchBlob(`/repos/${encodeURIComponent(GH_OWNER)}/${encodeURIComponent(GH_REPO)}/contents/${enc}?ref=main`);
      const url = URL.createObjectURL(blob);
      __imgUrlCache.set(key, url);
      return url;
    }

    // image upload helpers (HEIC + big -> jpeg)
    async function blobToBase64(blob){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => {
          const dataUrl = String(r.result || '');
          const b64 = dataUrl.split(',')[1] || '';
          resolve(b64);
        };
        r.onerror = () => reject(r.error);
        r.readAsDataURL(blob);
      });
    }

    async function compressToJpegBase64(file, opts = {}){
      const { maxSide = 1600, quality = 0.82 } = opts;
      const url = URL.createObjectURL(file);
      try {
        const img = await new Promise((resolve, reject) => {
          const im = new Image();
          im.onload = () => resolve(im);
          im.onerror = reject;
          im.src = url;
        });

        const w0 = img.naturalWidth || img.width;
        const h0 = img.naturalHeight || img.height;
        const scale = Math.min(1, maxSide / Math.max(w0, h0));
        const w = Math.max(1, Math.round(w0 * scale));
        const h = Math.max(1, Math.round(h0 * scale));

        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', quality));
        if (!blob) throw new Error('toBlob_failed');
        const b64 = await blobToBase64(blob);
        return { b64, ext: 'jpg', mime: 'image/jpeg' };
      } finally {
        URL.revokeObjectURL(url);
      }
    }

    async function readFileAsBase64(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => {
          const dataUrl = String(r.result || '');
          const b64 = dataUrl.split(',')[1] || '';
          resolve(b64);
        };
        r.onerror = () => reject(r.error);
        r.readAsDataURL(file);
      });
    }

    async function imageToUploadPayload(file){
      const name = String(file.name || '');
      const ext0 = (name.split('.').pop() || '').toLowerCase();
      const isHeic = (file.type && /heic|heif/i.test(file.type)) || ext0 === 'heic' || ext0 === 'heif';
      const isBig = (file.size || 0) > 2.5 * 1024 * 1024;

      if (isHeic || isBig) {
        try {
          return await compressToJpegBase64(file, { maxSide: 1600, quality: 0.82 });
        } catch (e) {
          console.warn('compress fail, fallback original', e);
        }
      }

      const b64 = await readFileAsBase64(file);
      const ext = ext0 || (file.type==='image/jpeg'?'jpg':file.type==='image/png'?'png':'bin');
      return { b64, ext, mime: file.type || 'application/octet-stream' };
    }

    // --- app state ---
    const CATEGORY_LABEL = {
      indoor: '室内',
      outdoor: '室外',
      food: '吃饭',
      nightlife: '夜生活',
      play: '玩耍',
    };

    let ideas = [];
    let curIdea = null;
    let logsIndex = { items: [] };

    // tag filter state (AND)
    const selectedTags = new Set();

    // group-by-tag-type view state
    // '' => no grouping, otherwise one of: t/v/c/p
    let activeGroupType = '';
    const collapsedGroups = new Set(); // key: `${type}:${tag}`
    function hasTag(it, tag){
      return Array.isArray(it.tags) && it.tags.includes(tag);
    }
    function matchSelected(it){
      for (const t of selectedTags) {
        if (!hasTag(it, t)) return false;
      }
      return true;
    }
    function addFilter(tag){
      if (!tag) return;
      selectedTags.add(tag);
      renderSelectedFilters();
      renderIdeas();
    }
    function removeFilter(tag){
      selectedTags.delete(tag);
      renderSelectedFilters();
      renderIdeas();
    }
    function clearFilters(){
      selectedTags.clear();
      renderSelectedFilters();
      renderIdeas();
    }
    function renderSelectedFilters(){
      const box = $('selectedFilters');
      const clearBtn = $('clearFilters');
      const arr = Array.from(selectedTags);
      if (!arr.length) {
        box.style.display = 'none';
        clearBtn.style.display = 'none';
        box.innerHTML = '';
        return;
      }
      box.style.display = 'flex';
      clearBtn.style.display = 'inline-block';

      // stable order: t,v,c,p,x
      const order = { t:0, v:1, c:2, p:3, x:4 };
      arr.sort((a,b)=> (order[tagType(a)]??9) - (order[tagType(b)]??9));

      box.innerHTML = arr.map(t => {
        const ty = tagType(t);
        return `<span class="tag ${ty}" data-tag="${escapeHtml(t)}" title="点击移除">${escapeHtml(tagLabel(t))} ×</span>`;
      }).join('');

      // bind remove
      box.querySelectorAll('.tag').forEach(el => {
        el.addEventListener('click', (e) => {
          e.preventDefault();
          const t = el.getAttribute('data-tag') || '';
          removeFilter(t);
        });
      });
    }

    function groupIdeas(items){
      // category -> group -> [items]
      const out = new Map();
      for (const it of items) {
        const cat = it.category || 'other';
        const grp = it.group || '';
        if (!out.has(cat)) out.set(cat, new Map());
        const m = out.get(cat);
        if (!m.has(grp)) m.set(grp, []);
        m.get(grp).push(it);
      }
      return out;
    }

    function renderIdeaButton(it){
      const btn = document.createElement('button');
      btn.className = 'ideaBtn' + (curIdea && curIdea.id === it.id ? ' sel' : '');
      btn.type = 'button';
      const tagsHtml = (Array.isArray(it.tags) && it.tags.length) ? renderTagsHtml(it.tags) : '';
      btn.innerHTML = `<div class="ideaTitle">${escapeHtml(it.title || it.id)}</div>` + (tagsHtml ? `<div class="ideaTags">${tagsHtml}</div>` : '');

      // tag click => filter
      btn.querySelectorAll('.tag[data-tag]').forEach(tel => {
        tel.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const t = tel.getAttribute('data-tag') || '';
          addFilter(t);
        });
      });

      btn.onclick = () => {
        curIdea = it;
        $('curIdeaTitle').textContent = it.title || it.id;
        renderIdeas();
        renderLogs();
      };
      return btn;
    }

    function renderIdeas(){
      const el = $('ideaList');
      el.innerHTML = '';

      const total = ideas.length;
      const filtered = ideas.filter(matchSelected);
      const n = filtered.length;
      $('stat').textContent = selectedTags.size ? `筛选后 ${n} / ${total} 项` : `共 ${total} 项`;

      // no grouping
      if (!activeGroupType) {
        const items = filtered.slice().sort((a,b) => String(a.title||'').localeCompare(String(b.title||''), 'zh-CN'));
        for (const it of items) el.appendChild(renderIdeaButton(it));
        return;
      }

      // group by tag type (t/v/c/p)
      const groups = new Map(); // tag -> items
      for (const it of filtered) {
        const tags = Array.isArray(it.tags) ? it.tags : [];
        const ts = tags.filter(x => tagType(x) === activeGroupType);
        // if item has no tag of that type, drop into an "other" bucket
        const keys = ts.length ? ts : [`${activeGroupType}:__none__`];
        for (const k of keys) {
          if (!groups.has(k)) groups.set(k, []);
          groups.get(k).push(it);
        }
      }

      const groupKeys = Array.from(groups.keys()).sort((a,b) => {
        // keep __none__ last
        const an = String(a).includes('__none__');
        const bn = String(b).includes('__none__');
        if (an !== bn) return an ? 1 : -1;
        return String(tagLabel(a)).localeCompare(String(tagLabel(b)), 'zh-CN');
      });

      for (const k of groupKeys) {
        const items = groups.get(k) || [];
        items.sort((a,b) => String(a.title||'').localeCompare(String(b.title||''), 'zh-CN'));

        const isNone = String(k).includes('__none__');
        const title = isNone ? '（未标注）' : tagLabel(k);
        const key2 = `${activeGroupType}:${k}`;
        const collapsed = collapsedGroups.has(key2);

        const header = document.createElement('button');
        header.type = 'button';
        header.className = 'ideaBtn';
        header.style.display = 'flex';
        header.style.alignItems = 'center';
        header.style.justifyContent = 'space-between';
        header.style.gap = '10px';
        header.innerHTML = `<div style="font-weight:950;">${escapeHtml(title)}</div><div class="meta">${items.length} 项 · ${collapsed ? '展开' : '收起'}</div>`;
        header.onclick = () => {
          if (collapsedGroups.has(key2)) collapsedGroups.delete(key2);
          else collapsedGroups.add(key2);
          renderIdeas();
        };
        el.appendChild(header);

        if (collapsed) continue;
        for (const it of items) el.appendChild(renderIdeaButton(it));
      }
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // --- Tag display (make tags readable) ---
    // Keep ideas.json tags as typed keys (t:/v:/c:/p:/x:), but display Chinese labels with colors.
    const TAG_CN = {
      // t: （收敛后的 6 类）
      't:outdoor':'户外',
      't:food':'吃喝',
      't:life':'室内/日常',
      't:nightlife':'夜生活',
      't:culture':'文化/手作',
      't:watch':'观影/追剧',

      // v:
      'v:challenge':'挑战/运动',
      'v:cozy':'舒服/松弛',
      'v:fun':'热闹/好玩',
      'v:healing':'治愈/放松',
      'v:photo':'出片',
      'v:romantic':'浪漫',

      // c:
      'c:indoor':'室内',
      'c:outdoor':'室外',

      // p: (常用地点)
      'p:shenzhen':'深圳',
      'p:guangzhou':'广州',
      'p:shenzhen-bay-park':'深圳湾公园',
      'p:qiedao':'企鹅岛',
      'p:xiwan-hongshulin':'西湾红树林',
      'p:huanle-gangwan':'欢乐港湾',
      'p:haishijie':'海上世界',
      'p:nantou-gucheng':'南头古城',
      'p:daxuecheng':'大学城',
      'p:f518':'F518 创意园',
      'p:dafen-youhuacun':'大芬油画村',
      'p:laifushi':'来福士',
      'p:haiancheng':'海岸城',
      'p:yuexiu-gongyuan':'越秀公园',
      'p:bulaien-gongyuan':'布莱恩公园',
      'p:bulage-dongjing':'布歌东京'
    };

    function tagType(tag){
      const m = /^([tvcp x]):/.exec(String(tag||''));
      if (/^t:/.test(tag)) return 't';
      if (/^v:/.test(tag)) return 'v';
      if (/^c:/.test(tag)) return 'c';
      if (/^p:/.test(tag)) return 'p';
      if (/^x:/.test(tag)) return 'x';
      return 'x';
    }

    function tagLabel(tag){
      const key = String(tag||'');
      if (TAG_CN[key]) return TAG_CN[key];
      // fallback: strip prefix and show raw
      const idx = key.indexOf(':');
      return idx > 0 ? key.slice(idx+1) : key;
    }

    function renderTagsHtml(tags){
      const arr = Array.isArray(tags) ? tags : [];
      // order: t, v, c, p, x
      const order = { t:0, v:1, c:2, p:3, x:4 };
      const sorted = arr.slice().sort((a,b)=> (order[tagType(a)]??9) - (order[tagType(b)]??9));
      return sorted.map(t => {
        const ty = tagType(t);
        return `<span class="tag ${ty}" data-tag="${escapeHtml(t)}" title="${escapeHtml(t)}">${escapeHtml(tagLabel(t))}</span>`;
      }).join('');
    }

    async function loadIdeas(){
      const r = await fetch('./ideas.json', { cache: 'no-store' });
      const j = await r.json();
      ideas = Array.isArray(j) ? j : [];
      renderSelectedFilters();
      renderIdeas();
    }

    async function loadLogsIndex(){
      const idx = await ghTryGetJson('dates/index.json');
      logsIndex = (idx && typeof idx === 'object') ? idx : { items: [] };
      logsIndex.items = Array.isArray(logsIndex.items) ? logsIndex.items : [];
    }

    async function renderLogs(){
      const el = $('logs');
      const title = $('logsTitle');
      el.innerHTML = '';
      if (!curIdea) {
        title.textContent = '关联日记';
        el.innerHTML = '<div class="meta">左边选一项，我就把日记都给你翻出来～</div>';
        return;
      }

      title.textContent = `「${curIdea.title || curIdea.id}」的日记`;

      const items = (logsIndex.items || []).filter(x => Array.isArray(x.ideaIds) && x.ideaIds.includes(curIdea.id));
      items.sort((a,b) => (b.ts||0) - (a.ts||0));

      if (!items.length) {
        el.innerHTML = '<div class="meta">还没有日记。写一篇吧～</div>';
        return;
      }

      for (const it of items.slice(0, 50)) {
        const div = document.createElement('div');
        div.className = 'item';
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${new Date(it.ts || Date.now()).toLocaleString('zh-CN')} · ${it.author || ''}`.trim();
        const text = document.createElement('div');
        text.className = 'text';
        text.textContent = it.text || '';
        div.appendChild(meta);
        if (text.textContent) div.appendChild(text);

        const imgsArr = Array.isArray(it.images) ? it.images : [];
        if (imgsArr.length) {
          const imgs = document.createElement('div');
          imgs.className = 'imgs';
          for (const p of imgsArr.slice(0, 12)) {
            const img = document.createElement('img');
            img.alt = 'photo';
            img.loading = 'lazy';
            img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='; // 1x1 placeholder
            (async () => {
              try {
                const url = await getPrivateImageUrl(p);
                img.src = url;
                img.onclick = () => openImg(url);
              } catch (e) {
                console.warn('load image failed', p, e);
              }
            })();
            imgs.appendChild(img);
          }
          div.appendChild(imgs);
        }

        el.appendChild(div);
      }
    }

    function setGroupType(t){
      activeGroupType = t || '';
      // reset collapse state when switching
      collapsedGroups.clear();
      // update button styles (simple selected outline)
      ['t','v','c','p','none'].forEach(k => {
        const id = k==='none' ? 'group_none' : ('group_' + k);
        const el = $(id);
        if (!el) return;
        const on = (k==='none' ? !activeGroupType : activeGroupType===k);
        el.style.outline = on ? '3px solid rgba(11,42,120,0.18)' : 'none';
      });
      renderIdeas();
    }

    $('reloadIdeas').onclick = () => loadIdeas();
    $('clearFilters').onclick = () => clearFilters();

    // group type buttons
    $('group_t').onclick = () => setGroupType('t');
    $('group_v').onclick = () => setGroupType('v');
    $('group_c').onclick = () => setGroupType('c');
    $('group_p').onclick = () => setGroupType('p');
    $('group_none').onclick = () => setGroupType('');

    $('save').onclick = async () => {
      if (!curIdea) { toast('先选一项约会～'); return; }
      const btn = $('save');
      const text = String($('text').value || '').trim();
      const files = selectedFiles.length ? selectedFiles : Array.from($('photos').files || []);
      if (!text && files.length === 0) { toast('写点什么或传张照片再保存哦～'); return; }

      const old = btn.textContent;
      btn.disabled = true;
      btn.textContent = '保存中…';

      try {
        const ts = Date.now();
        const d = new Date(ts);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const HH = String(d.getHours()).padStart(2,'0');
        const MM = String(d.getMinutes()).padStart(2,'0');
        const SS = String(d.getSeconds()).padStart(2,'0');
        const day = `${yyyy}-${mm}-${dd}`;
        const dayDir = `dates/${day}`;
        const stamp = `${HH}${MM}${SS}`;

        const author = (window.__AUTH__ && window.__AUTH__.user) ? String(window.__AUTH__.user) : '';

        // upload images first
        const imgPaths = [];
        for (let i=0;i<files.length;i++) {
          btn.textContent = `上传照片 ${i+1}/${files.length}…`;
          const payload = await imageToUploadPayload(files[i]);
          const path = `${dayDir}/images/${stamp}-${i+1}.${payload.ext}`;
          imgPaths.push(path);
          await ghPutFile(path, payload.b64, `Add date photo ${day} ${stamp} #${i+1}`);
        }

        // update day entries
        const dailyPath = `${dayDir}/entries.json`;
        const daily = (await ghTryGetJson(dailyPath)) || { day, items: [] };
        daily.items = Array.isArray(daily.items) ? daily.items : [];
        daily.items.unshift({ ts, ideaIds: [curIdea.id], text, images: imgPaths, author });
        await ghPutFile(dailyPath, await base64Utf8(JSON.stringify(daily, null, 2)), `Update date entries ${day}`);

        // update global index
        const idxPath = 'dates/index.json';
        const idx = (await ghTryGetJson(idxPath)) || { items: [] };
        idx.items = Array.isArray(idx.items) ? idx.items : [];
        idx.items.unshift({ ts, day, ideaIds: [curIdea.id], text, images: imgPaths, author });
        idx.items = idx.items.slice(0, 400);
        await ghPutFile(idxPath, await base64Utf8(JSON.stringify(idx, null, 2)), `Update dates index ${day}`);

        // refresh view
        logsIndex = idx;
        $('text').value = '';
        $('photos').value = '';
        selectedFiles = [];
        renderThumbs();

        toast('已保存～');
        await renderLogs();
      } catch (e) {
        console.warn(e);
        toast('保存失败：' + String(e).slice(0, 120));
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    };

    (async () => {
      const ok = await ensurePassAndToken();
      if (!ok) return;
      await loadIdeas();
      await loadLogsIndex();
      await renderLogs();
    })();
  </script>
</body>
</html>
